"""
MicroPython Web Server for Raspberry Pi Pico W
Driver IO Remote Control Dashboard

This script starts a web server that serves a dashboard for remote control
of a Raspberry Pi 4 (startup/shutdown functionality).
"""

import network
import socket
import time
from machine import Pin

# ============================================================================
# GPIO PIN CONFIGURATION
# ============================================================================
# TODO: Define your GPIO pins here for controlling the Raspberry Pi 4
# Example:
# BOOT_PIN = Pin(16, Pin.OUT)  # GPIO pin to trigger Pi boot
# REBOOT_PIN = Pin(17, Pin.OUT)  # GPIO pin to trigger Pi reboot


def parse_wifi_config(filename="wifi_config.txt"):
    """
    Parse WiFi credentials from a text file.
    
    Expected file format:
    SSID=your_wifi_ssid
    PASSWORD=your_wifi_password
    
    Args:
        filename: Path to the WiFi configuration file
        
    Returns:
        tuple: (ssid, password)
    """
    ssid = None
    password = None
    
    try:
        with open(filename, "r") as f:
            for line in f:
                line = line.strip()
                if line.startswith("SSID="):
                    ssid = line[5:]
                elif line.startswith("PASSWORD="):
                    password = line[9:]
    except OSError:
        print(f"Error: Could not read {filename}")
        return None, None
    
    return ssid, password


def connect_wifi(ssid, password, timeout=10):
    """
    Connect to a WiFi network.
    
    Args:
        ssid: WiFi network name
        password: WiFi password
        timeout: Connection timeout in seconds
        
    Returns:
        str: IP address if connected, None otherwise
    """
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    
    if wlan.isconnected():
        print("Already connected to WiFi")
        return wlan.ifconfig()[0]
    
    print(f"Connecting to WiFi: {ssid}")
    wlan.connect(ssid, password)
    
    start_time = time.time()
    while not wlan.isconnected():
        if time.time() - start_time > timeout:
            print("WiFi connection timeout")
            return None
        time.sleep(0.5)
        print(".", end="")
    
    ip_address = wlan.ifconfig()[0]
    print(f"\nConnected! IP address: {ip_address}")
    return ip_address


def get_html_page():
    """
    Generate the HTML page for the dashboard.
    
    Returns:
        str: HTML content
    """
    html = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver IO Remote Control Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #CC0000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        h1 {
            margin-bottom: 40px;
            text-align: center;
            color: #CC0000;
            font-size: 28px;
        }
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #CC0000;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }
        .btn-boot {
            background-color: #CC0000;
            color: white;
        }
        .btn-boot:hover {
            background-color: #990000;
            transform: scale(1.05);
        }
        .btn-reboot {
            background-color: white;
            color: #CC0000;
        }
        .btn-reboot:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }
        .status {
            margin-top: 30px;
            padding: 15px;
            background-color: #f5f5f5;
            border: 2px solid #CC0000;
            border-radius: 8px;
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
    <img src="data:image/jpeg;base64,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
    <h1>Driver IO Remote Control Dashboard</h1>
    <div class="button-container">
        <a href="/boot" class="btn btn-boot">Boot up Pi</a>
        <a href="/reboot" class="btn btn-reboot">Soft Reboot</a>
    </div>
    <div class="status" id="status">
        Ready for commands
    </div>
</body>
</html>"""
    return html


def get_response_page(action):
    """
    Generate a response page after an action is triggered.
    
    Args:
        action: The action that was triggered ('boot', 'reboot', or 'shutdown')
        
    Returns:
        str: HTML content
    """
    if action == "boot":
        action_text = "Boot up Pi"
    elif action == "reboot":
        action_text = "Soft Reboot"
    else:
        action_text = "Shutdown Pi"
    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="3;url=/">
    <title>Driver IO remote control dashboard</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #CC0000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }}
        h1 {{
            color: #CC0000;
            margin-bottom: 20px;
        }}
        .message {{
            background-color: #f5f5f5;
            border: 2px solid #CC0000;
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
        }}
        .success {{
            color: #CC0000;
            font-weight: bold;
        }}
    </style>
</head>
<body>
    <h1>Driver IO remote control dashboard</h1>
    <div class="message">
        <p class="success">Command sent: {action_text}</p>
        <p>Redirecting back to dashboard...</p>
    </div>
</body>
</html>"""
    return html


def handle_boot():
    """
    Handle the Boot up Pi action.
    
    This function triggers the GPIO pin to boot up the Raspberry Pi 4.
    """
    print("Boot up Pi command received")
    
    # ========================================================================
    # TODO: Add GPIO control code here to boot up the Raspberry Pi 4
    # ========================================================================
    # Example:
    # BOOT_PIN.value(1)  # Set pin HIGH to trigger boot
    # time.sleep(0.5)    # Hold for 500ms
    # BOOT_PIN.value(0)  # Set pin LOW
    # ========================================================================
    
    pass


def handle_reboot():
    """
    Handle the Soft Reboot action.
    
    This function triggers the GPIO pin to soft reboot the Raspberry Pi 4.
    """
    print("Soft Reboot command received")
    
    # ========================================================================
    # TODO: Add GPIO control code here to soft reboot the Raspberry Pi 4
    # ========================================================================
    # Example:
    # REBOOT_PIN.value(1)  # Set pin HIGH to trigger reboot
    # time.sleep(0.5)      # Hold for 500ms
    # REBOOT_PIN.value(0)  # Set pin LOW
    # ========================================================================
    
    pass


def start_server(ip_address, port=80):
    """
    Start the web server.
    
    Args:
        ip_address: IP address to bind to
        port: Port number (default 80)
    """
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('', port))
    server_socket.listen(5)
    
    print(f"Web server running on http://{ip_address}:{port}")
    print("Press Ctrl+C to stop the server")
    
    while True:
        try:
            client, client_addr = server_socket.accept()
            print(f"Connection from {client_addr}")
            
            request = client.recv(1024).decode("utf-8")
            
            # Parse the request to get the path
            path = "/"
            try:
                request_line = request.split("\r\n")[0]
                parts = request_line.split(" ")
                if len(parts) >= 2:
                    path = parts[1]
            except (IndexError, ValueError):
                # Handle malformed requests gracefully
                path = "/"
            
            # Handle different routes
            if path == "/boot":
                handle_boot()
                response = get_response_page("boot")
            elif path == "/reboot":
                handle_reboot()
                response = get_response_page("reboot")
            else:
                response = get_html_page()
            
            # Send HTTP response (combine headers to avoid partial sends)
            http_response = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: close\r\n\r\n" + response
            client.sendall(http_response.encode("utf-8"))
            
            client.close()
            
        except Exception as e:
            print(f"Error handling request: {e}")
            try:
                client.close()
            except:
                pass


def main():
    """
    Main entry point for the application.
    """
    try:
        print("=" * 50)
        print("Driver IO Remote Control Dashboard")
        print("=" * 50)
        
        # Parse WiFi credentials from config file
        ssid, password = parse_wifi_config()
        
        if not ssid or not password:
            print("Error: Could not read WiFi credentials from wifi_config.txt")
            print("Please ensure the file exists with format:")
            print("SSID=your_wifi_ssid")
            print("PASSWORD=your_wifi_password")
            return
        
        # Connect to WiFi
        ip_address = connect_wifi(ssid, password)
        
        if not ip_address:
            print("Error: Could not connect to WiFi")
            return
        
        # Start the web server
        start_server(ip_address)
        
    except Exception as e:
        print(f"FATAL ERROR: {e}")
        import sys
        sys.print_exception(e)


# Run the main function when the script is executed
if __name__ == "__main__":
    main()
